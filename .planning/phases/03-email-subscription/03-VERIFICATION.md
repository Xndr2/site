---
phase: 03-email-subscription
verified: 2026-02-23T22:00:00Z
status: passed
score: 18/18 must-haves verified
re_verification: false
human_verification:
  - test: "Submit subscribe form with valid email on /blog"
    expected: "Form replaces itself with 'Check your inbox to confirm!' message; Resend sends branded confirmation email"
    why_human: "Requires live Resend API key and RESEND_AUDIENCE_ID env vars; cannot verify email delivery programmatically"
  - test: "Click confirmation link from email"
    expected: "Browser redirects to /confirm page showing 'You're subscribed!' with checkmark icon"
    why_human: "Requires a real confirmation token generated by live createToken(); end-to-end flow needs live env"
  - test: "POST /api/notify with correct Bearer token after subscriber confirmed"
    expected: "All confirmed subscribers receive styled notification email; response returns { sent: N, post: title }"
    why_human: "Requires live NOTIFY_SECRET, RESEND_API_KEY, and confirmed subscriber in audience"
  - test: "Click unsubscribe link from notification email"
    expected: "Browser redirects to /unsubscribe page; contact marked unsubscribed in Resend dashboard"
    why_human: "Requires live token signed with SUBSCRIBE_SECRET and real Resend contact"
  - test: "SPF and DKIM DNS records for xndr.site"
    expected: "Resend Dashboard shows xndr.site as 'Verified'; confirmation and notification emails not in spam"
    why_human: "External DNS state — cannot verify from codebase; SUMMARY claims user completed this during Task 2"
---

# Phase 3: Email Subscription Verification Report

**Phase Goal:** Blog visitors can subscribe to email notifications, confirm via double opt-in, receive styled notification emails when new posts are published, and unsubscribe with one click
**Verified:** 2026-02-23T22:00:00Z
**Status:** passed
**Re-verification:** No — initial verification

---

## Goal Achievement

### Observable Truths

All truths are drawn directly from the three PLAN frontmatter `must_haves.truths` blocks.

#### Plan 01 Truths

| # | Truth | Status | Evidence |
|---|-------|--------|----------|
| 1 | Resend SDK is installed and a singleton client is importable | VERIFIED | `package.json` lists `resend@^6.9.2`; `app/lib/resend.ts` exports `resend` Proxy singleton and `getResend()` |
| 2 | HMAC tokens can be created and verified with timing-safe comparison | VERIFIED | `app/lib/tokens.ts` uses `crypto.createHmac('sha256', SECRET)`, `Buffer.from`, and `crypto.timingSafeEqual`; 24-hour expiry enforced |
| 3 | Rate limiting function returns boolean based on IP and configurable window | VERIFIED | `app/lib/rate-limit.ts` exports `checkRateLimit(ip, limit=5, windowMs=60*60*1000): boolean` using in-memory Map |
| 4 | Email templates render branded HTML with site logo, colors, social links footer, and unsubscribe link | VERIFIED | `app/emails/base-layout.tsx` renders avatar Img (`XndrPFP_cat.png`), GitHub/Twitter/xndr.site social links in `#4da6db`, optional unsubscribe link |
| 5 | Confirmation and notification emails share the same base layout | VERIFIED | Both `confirmation-email.tsx` and `notification-email.tsx` import and wrap with `<BaseLayout>` |
| 6 | Confirm page shows success message with link back to blog | VERIFIED | `app/confirm/page.tsx` renders "You're subscribed!", checkmark SVG, and `<Link href="/blog">Back to blog</Link>` |
| 7 | Unsubscribe page shows confirmation message | VERIFIED | `app/unsubscribe/page.tsx` renders "You've been unsubscribed" with mail-off SVG and link to `/blog` |

#### Plan 02 Truths

| # | Truth | Status | Evidence |
|---|-------|--------|----------|
| 8 | Visitor sees a subscribe card on the blog index page after the posts list | VERIFIED | `app/blog/page.tsx` imports `SubscribeForm` and renders `<SubscribeForm />` at line 131 inside a `mt-16` div after the posts section |
| 9 | Visitor sees a subscribe card at the end of each blog post | VERIFIED | `app/blog/[slug]/page.tsx` imports `SubscribeForm` and renders `<SubscribeForm />` at line 204 inside a `mt-12` div after the back-link footer |
| 10 | Submitting the form with valid email shows inline success message replacing the form | VERIFIED | `subscribe-form.tsx` state machine transitions to `'success'` on `res.ok`; renders separate success card (not the form) with "Check your inbox to confirm!" |
| 11 | Honeypot-filled submissions get silent 200 (bot protection) | VERIFIED | `app/api/subscribe/route.ts` line 21: `if (honeypot) { return NextResponse.json({ message: 'Success' }) }` |
| 12 | Rate-limited IPs get 429 response | VERIFIED | `app/api/subscribe/route.ts` line 12: `if (!checkRateLimit(ip)) { return NextResponse.json({ error: 'Too many requests' }, { status: 429 }) }` |
| 13 | Subscribe API creates unconfirmed contact in Resend and sends confirmation email | VERIFIED | Route calls `resend.contacts.create({ ..., unsubscribed: true })` then `resend.emails.send({ react: ConfirmationEmail(...) })` |
| 14 | Clicking confirm link in email verifies token and activates subscriber in Resend | VERIFIED | `app/api/confirm/route.ts` calls `verifyToken(token)`, looks up contact, then `resend.contacts.update({ unsubscribed: false })` |
| 15 | Confirm API redirects to /confirm page after successful verification | VERIFIED | Line 38: `return NextResponse.redirect(new URL('/confirm', request.url))` |

#### Plan 03 Truths

| # | Truth | Status | Evidence |
|---|-------|--------|----------|
| 16 | When notify endpoint is triggered with correct secret, all confirmed subscribers receive notification email | VERIFIED | `app/api/notify/route.ts` checks Bearer auth, paginates all contacts, filters `!c.unsubscribed`, batch sends via `resend.batch.send()` |
| 17 | Notify endpoint rejects requests without valid Bearer token | VERIFIED | Line 18: `if (authorization !== \`Bearer ${process.env.NOTIFY_SECRET}\`) { return 401 }` |
| 18 | Every notification email includes List-Unsubscribe and List-Unsubscribe-Post headers | VERIFIED | Lines 79-80 in notify route: `'List-Unsubscribe': \`<...unsubscribe?token=...>\`` and `'List-Unsubscribe-Post': 'List-Unsubscribe=One-Click'` on every batched email |
| 19 | Clicking unsubscribe link marks subscriber as unsubscribed in Resend | VERIFIED | `app/api/unsubscribe/route.ts`: verifies token, looks up contact, calls `resend.contacts.update({ unsubscribed: true })` |
| 20 | Unsubscribe endpoint redirects to /unsubscribe landing page | VERIFIED | Line 41: `return NextResponse.redirect(new URL('/unsubscribe', request.url))` |
| 21 | SPF and DKIM DNS records are configured for xndr.site | HUMAN NEEDED | Per 03-03-SUMMARY.md, user completed DNS configuration during Task 2 checkpoint. Cannot verify external DNS from codebase. |

**Score (automated):** 20/21 truths verified (1 requires human verification of external DNS state)

---

## Required Artifacts

| Artifact | Expected | Status | Details |
|----------|----------|--------|---------|
| `app/lib/resend.ts` | Resend client singleton and audience ID | VERIFIED | Exports `resend` Proxy, `getResend()`, `AUDIENCE_ID`, `AUDIENCE_FROM` |
| `app/lib/tokens.ts` | HMAC token creation and verification | VERIFIED | Exports `createToken`, `verifyToken` with `timingSafeEqual` and 24h expiry |
| `app/lib/rate-limit.ts` | In-memory IP rate limiter | VERIFIED | Exports `checkRateLimit` with configurable limit/window |
| `app/emails/base-layout.tsx` | Shared branded email layout | VERIFIED | `BaseLayout` component with avatar, social links, optional unsubscribe link |
| `app/emails/confirmation-email.tsx` | Double opt-in confirmation email | VERIFIED | `ConfirmationEmail` with CTA button, fallback link, 24h expiry note |
| `app/emails/notification-email.tsx` | New post notification email | VERIFIED | `NotificationEmail` with post title, "Read the post" CTA, unsubscribeUrl prop |
| `app/confirm/page.tsx` | Subscription confirmed landing page | VERIFIED | Server Component with Navbar, checkmark SVG, success copy, /blog link |
| `app/unsubscribe/page.tsx` | Unsubscribed landing page | VERIFIED | Server Component with Navbar, mail-off SVG, unsubscribed copy, /blog link |
| `app/api/subscribe/route.ts` | POST handler for email subscription | VERIFIED | Exports `POST`; full validation, honeypot, rate limit, contact creation, email send |
| `app/api/confirm/route.ts` | GET handler for token verification | VERIFIED | Exports `GET`; token verify, contact lookup, `contacts.update`, redirect |
| `app/blog/_components/subscribe-form.tsx` | Client Component subscribe form | VERIFIED | `'use client'`; name + email + honeypot; idle/loading/success/error state machine |
| `app/blog/page.tsx` | Blog index with SubscribeForm | VERIFIED | Imports and renders `<SubscribeForm />` after posts timeline |
| `app/blog/[slug]/page.tsx` | Blog post page with SubscribeForm | VERIFIED | Imports and renders `<SubscribeForm />` after footer back-link |
| `app/api/notify/route.ts` | POST handler for sending notifications | VERIFIED | Exports `POST`; Bearer auth, paginated fetch, batch send, List-Unsubscribe headers |
| `app/api/unsubscribe/route.ts` | GET + POST handlers for unsubscribe | VERIFIED | Exports both `GET` and `POST`; shared `handleUnsubscribe` helper; RFC 8058 compliant |

All 15 artifacts: VERIFIED (exist, substantive, wired)

---

## Key Link Verification

### Plan 01 Key Links

| From | To | Via | Status | Evidence |
|------|----|-----|--------|---------|
| `app/emails/confirmation-email.tsx` | `app/emails/base-layout.tsx` | imports BaseLayout | WIRED | Line 3: `import { BaseLayout } from './base-layout'` |
| `app/emails/notification-email.tsx` | `app/emails/base-layout.tsx` | imports BaseLayout | WIRED | Line 3: `import { BaseLayout } from './base-layout'` |
| `app/lib/tokens.ts` | `SUBSCRIBE_SECRET` env var | `process.env.SUBSCRIBE_SECRET` | WIRED | Line 3: `const SECRET = process.env.SUBSCRIBE_SECRET!` |
| `app/lib/resend.ts` | `RESEND_AUDIENCE_ID` env var | `process.env.RESEND_AUDIENCE_ID` | WIRED | Line 19: `export const AUDIENCE_ID = process.env.RESEND_AUDIENCE_ID!` |

### Plan 02 Key Links

| From | To | Via | Status | Evidence |
|------|----|-----|--------|---------|
| `app/blog/_components/subscribe-form.tsx` | `/api/subscribe` | fetch POST on form submit | WIRED | Line 19: `await fetch('/api/subscribe', { method: 'POST', ... })` |
| `app/api/subscribe/route.ts` | `app/lib/resend.ts` | imports resend client | WIRED | Line 2: `import { resend, AUDIENCE_FROM, AUDIENCE_ID } from '@/app/lib/resend'` |
| `app/api/subscribe/route.ts` | `app/lib/tokens.ts` | imports createToken | WIRED | Line 3: `import { createToken } from '@/app/lib/tokens'` |
| `app/api/subscribe/route.ts` | `app/emails/confirmation-email.tsx` | imports ConfirmationEmail | WIRED | Line 5: `import { ConfirmationEmail } from '@/app/emails/confirmation-email'` |
| `app/api/confirm/route.ts` | `app/lib/tokens.ts` | imports verifyToken | WIRED | Line 3: `import { verifyToken } from '@/app/lib/tokens'` |
| `app/api/confirm/route.ts` | `app/lib/resend.ts` | imports resend + AUDIENCE_ID | WIRED | Line 2: `import { resend, AUDIENCE_ID } from '@/app/lib/resend'` |

### Plan 03 Key Links

| From | To | Via | Status | Evidence |
|------|----|-----|--------|---------|
| `app/api/notify/route.ts` | `app/lib/resend.ts` | imports resend + AUDIENCE_ID | WIRED | Line 2: `import { resend, AUDIENCE_FROM, AUDIENCE_ID } from '@/app/lib/resend'` |
| `app/api/notify/route.ts` | `app/lib/tokens.ts` | imports createToken | WIRED | Line 3: `import { createToken } from '@/app/lib/tokens'` |
| `app/api/notify/route.ts` | `app/emails/notification-email.tsx` | imports NotificationEmail | WIRED | Line 4: `import { NotificationEmail } from '@/app/emails/notification-email'` |
| `app/api/notify/route.ts` | `app/lib/blog.ts` | imports getAllPosts | WIRED | Line 5: `import { getAllPosts } from '@/app/lib/blog'` |
| `app/api/unsubscribe/route.ts` | `app/lib/tokens.ts` | imports verifyToken | WIRED | Line 3: `import { verifyToken } from '@/app/lib/tokens'` |
| `app/api/unsubscribe/route.ts` | `app/lib/resend.ts` | imports resend + AUDIENCE_ID | WIRED | Line 2: `import { resend, AUDIENCE_ID } from '@/app/lib/resend'` |

All 16 key links: WIRED

---

## Requirements Coverage

Requirements from plans: EMAIL-01, EMAIL-02, EMAIL-03, EMAIL-04, EMAIL-05, EMAIL-06, EMAIL-07, EMAIL-08

| Requirement | Source Plan | Description | Status | Evidence |
|-------------|------------|-------------|--------|---------|
| EMAIL-01 | 03-02 | Subscribe form in blog page — email input, hidden honeypot field, client-side email validation | SATISFIED | `subscribe-form.tsx` has email input (`type="email" required`), hidden honeypot (`_hp_name` via CSS positioning), and state-based validation display; rendered on both `/blog` and `/blog/[slug]` |
| EMAIL-02 | 03-02 | POST /api/subscribe — validates email server-side, rate-limits by IP, adds unconfirmed contact, sends double opt-in email | SATISFIED | `app/api/subscribe/route.ts`: email regex validation, `checkRateLimit(ip)`, `resend.contacts.create({ unsubscribed: true })`, `resend.emails.send({ react: ConfirmationEmail(...) })` |
| EMAIL-03 | 03-02 | GET /api/confirm?token= — activates subscriber status in Resend Audiences | SATISFIED | `app/api/confirm/route.ts`: verifies HMAC token, looks up contact by email, calls `resend.contacts.update({ unsubscribed: false })`, redirects to `/confirm` |
| EMAIL-04 | 03-01, 03-03 | Every outgoing email includes a working one-click unsubscribe link | SATISFIED | `BaseLayout` renders optional `unsubscribeUrl` footer link; notification route sets `List-Unsubscribe` and `List-Unsubscribe-Post` headers on every email; `NotificationEmail` receives `unsubscribeUrl` prop |
| EMAIL-05 | 03-03 | POST /api/notify — fetches all confirmed subscribers, sends notification email to each | SATISFIED | `app/api/notify/route.ts`: paginates contacts via while loop with `has_more` + `after` cursor, filters `!c.unsubscribed`, sends via `resend.batch.send()` in groups of 100 |
| EMAIL-06 | 03-01 | Notification email uses styled HTML template — post title, prominent "Read post" link, unsubscribe footer | SATISFIED (with documented deviation) | `notification-email.tsx` renders post title, "Read the post" CTA button with fallback link, and unsubscribe footer via `BaseLayout`. Per user decision documented in CONTEXT.md and 03-01-SUMMARY.md: excerpt and reading time are excluded (overrides the generic requirement text). This is intentional. |
| EMAIL-07 | 03-02 | Subscribe form shows inline success message after submit | SATISFIED | `subscribe-form.tsx`: on `res.ok`, sets `state = 'success'` which renders separate card with "Check your inbox to confirm!" replacing the form entirely |
| EMAIL-08 | 03-03 | DNS records configured on xndr.site — SPF + DKIM via Resend dashboard | HUMAN NEEDED | 03-03-SUMMARY.md documents user completed this in Task 2 checkpoint (Resend account, domain verification, SPF/DKIM). Cannot verify external DNS from codebase. |

All 8 EMAIL requirements: 7 SATISFIED, 1 HUMAN NEEDED (DNS verification)

No orphaned requirements — all EMAIL-01 through EMAIL-08 appear in plan frontmatter and are covered.

---

## Anti-Patterns Found

Scanned all 13 implementation files.

| File | Line | Pattern | Severity | Impact |
|------|------|---------|----------|--------|
| `app/blog/_components/subscribe-form.tsx` | 80, 87 | `placeholder=` attribute | Info | HTML input placeholders — not stub code |

No stubs, no TODO/FIXME comments, no empty implementations, no console.log in production paths found across any file.

---

## Human Verification Required

### 1. Subscribe form end-to-end flow

**Test:** Visit `/blog`, enter a name and valid email in the subscribe card, click "Subscribe"
**Expected:** Form instantly replaces itself with "Check your inbox to confirm!" card; confirmation email arrives in inbox from `hey@xndr.site` with branded layout, avatar, social links footer, and "Confirm subscription" CTA button
**Why human:** Requires live RESEND_API_KEY, RESEND_AUDIENCE_ID, SUBSCRIBE_SECRET, and NEXT_PUBLIC_SITE_URL environment variables

### 2. Double opt-in confirmation

**Test:** Click the "Confirm subscription" link in the confirmation email
**Expected:** Browser redirects to `/confirm` page showing checkmark icon, "You're subscribed!" heading, and "Back to blog" link
**Why human:** Requires a real HMAC token generated with live SUBSCRIBE_SECRET; token has 24-hour expiry

### 3. Notification sending

**Test:** `curl -X POST https://xndr.site/api/notify -H "Authorization: Bearer $NOTIFY_SECRET"` with at least one confirmed subscriber
**Expected:** Response `{ "sent": N, "post": "Latest Post Title" }`; notification emails arrive with post title, "Read the post" button, and unsubscribe footer link
**Why human:** Requires live NOTIFY_SECRET, confirmed Resend subscriber, and a published blog post

### 4. One-click unsubscribe

**Test:** Click the "Unsubscribe" link in the footer of a notification email
**Expected:** Browser redirects to `/unsubscribe` page showing mail-off icon and "You've been unsubscribed"; Resend dashboard shows contact as unsubscribed
**Why human:** Requires a live unsubscribe token signed with SUBSCRIBE_SECRET and a real Resend contact

### 5. DNS / email deliverability

**Test:** Check Resend Dashboard -> Domains -> xndr.site; send test email and verify it does not land in spam
**Expected:** Domain shows "Verified" status; SPF and DKIM records shown as passing; emails land in inbox
**Why human:** External DNS state; 03-03-SUMMARY.md documents user completed this but it cannot be verified from the codebase

---

## Gaps Summary

No gaps. All automated must-haves pass.

The only open item is EMAIL-08 (DNS/SPF/DKIM for xndr.site), which is an external infrastructure concern that cannot be verified from code. The SUMMARY documents completion of the blocking human-action checkpoint. This is appropriately flagged for human verification, not a code gap.

One design deviation is noted and documented (not a gap): EMAIL-06 specifies "excerpt (150 chars), reading time" in the notification email, but the user explicitly decided "title + link only" in CONTEXT.md. The implementation follows the user's decision. This is intentional and documented in both 03-01-SUMMARY.md and the PLAN's NOTE comment.

---

_Verified: 2026-02-23T22:00:00Z_
_Verifier: Claude (gsd-verifier)_
