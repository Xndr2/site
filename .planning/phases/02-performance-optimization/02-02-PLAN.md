---
phase: 02-performance-optimization
plan: 02
type: execute
wave: 2
depends_on:
  - 02-01
files_modified:
  - app/projects/page.tsx
  - app/projects/_components/github-repos.tsx
  - app/projects/_components/github-repos-skeleton.tsx
  - app/projects/_components/github-repos-error.tsx
  - app/lib/github.ts
  - app/components/tech-stack.tsx
  - app/about-me/page.tsx
  - app/blog/[slug]/page.tsx
  - next.config.js
autonomous: true
requirements:
  - OPT-03
  - OPT-04
  - OPT-08

must_haves:
  truths:
    - "Every next/image usage in the codebase has a correct sizes prop matching its rendered layout, and only above-fold images have priority"
    - "The projects page shell (header + featured projects) renders immediately without waiting for GitHub data"
    - "GitHub repo cards stream in after the page shell via Suspense, with skeleton cards shown as fallback"
    - "When GitHub data fails to load, an in-section error message with a retry button is shown (not a full-page error)"
    - "Projects page GitHub data revalidates within 5 minutes (not 24 hours)"
    - "Static assets under /icons/ and /projects/ serve with long-lived cache headers"
  artifacts:
    - path: "app/projects/_components/github-repos.tsx"
      provides: "Async Server Component that fetches and renders GitHub repo cards"
      exports: ["default"]
    - path: "app/projects/_components/github-repos-skeleton.tsx"
      provides: "Skeleton fallback for GitHub repos section matching real card layout"
      exports: ["default"]
    - path: "app/projects/_components/github-repos-error.tsx"
      provides: "Client component showing error message with retry button for GitHub fetch failures"
      exports: ["default"]
    - path: "app/projects/page.tsx"
      provides: "Projects page with Suspense boundary wrapping GitHub repos"
      contains: "<Suspense"
    - path: "next.config.js"
      provides: "Cache-Control headers for static public assets"
      contains: "immutable"
  key_links:
    - from: "app/projects/page.tsx"
      to: "app/projects/_components/github-repos.tsx"
      via: "Suspense boundary import"
      pattern: "import.*GitHubRepos"
    - from: "app/projects/_components/github-repos.tsx"
      to: "app/lib/github.ts"
      via: "fetchGitHubRepos() call"
      pattern: "fetchGitHubRepos"
    - from: "app/projects/page.tsx"
      to: "react"
      via: "Suspense import"
      pattern: "import.*Suspense.*from.*react"
---

<objective>
Optimize image delivery across all pages, restructure the projects page for Suspense streaming, and configure ISR + caching headers for optimal data freshness and asset caching.

Purpose: These are the core performance optimizations that directly improve Core Web Vitals scores — correct `sizes` props reduce image download sizes (LCP improvement), Suspense streaming delivers instant page shells (perceived performance), and ISR + caching reduce server response times (TTFB improvement).

Output: All `next/image` usages have correct `sizes`, projects page streams GitHub data via Suspense, ISR set to 5 minutes, static assets get immutable cache headers.
</objective>

<execution_context>
@C:/Users/xndr/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/xndr/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-performance-optimization/02-CONTEXT.md
@.planning/phases/02-performance-optimization/02-RESEARCH.md
@.planning/phases/02-performance-optimization/02-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Audit and fix next/image sizes props across all files</name>
  <files>
    app/projects/page.tsx
    app/components/tech-stack.tsx
    app/about-me/page.tsx
    app/blog/[slug]/page.tsx
  </files>
  <action>
Fix the `sizes` prop on every `next/image` usage. The navbar already has correct `sizes="128px"` and `priority` — leave it alone. All other Image usages are missing `sizes`, which causes the browser to assume viewport-width and download oversized srcsets.

**1. `app/projects/page.tsx` — Featured project images (line ~175-179):**
These images render in a 2-column grid on md+ (`grid-cols-1 md:grid-cols-2`), each with `h-40 object-cover`. They are responsive and below the fold.

Add `sizes` prop to the `<Image>` in the featured projects `.map()`:
```tsx
<Image
  className="w-full h-40 object-cover rounded-lg mb-4"
  src={project.img}
  alt={project.name}
  placeholder="blur"
  sizes="(max-width: 768px) 100vw, 50vw"
/>
```
Do NOT add `priority` — these are below the fold (hero section is above).

**2. `app/components/tech-stack.tsx` — Skill icons on home page (line ~13-19):**
These icons have `width={50} height={50}` but render responsively via CSS: `md:h-10 h-6 w-auto`. On mobile they're ~24px, on desktop ~40px.

Add `sizes` prop:
```tsx
<Image
  src={tech.src}
  alt={tech.name}
  width={50}
  height={50}
  className="md:h-10 h-6 w-auto transition-all duration-200 group-hover:scale-110 opacity-70 group-hover:opacity-100 dark:invert"
  style={{ filter: 'brightness(0)' }}
  sizes="(max-width: 768px) 24px, 40px"
/>
```

**3. `app/about-me/page.tsx` — Skill category icons (line ~65-71):**
These icons have `width={16} height={16}` and render at a fixed 16px regardless of viewport.

Add `sizes` prop:
```tsx
<Image
  src={tech.src}
  alt={tech.name}
  width={16}
  height={16}
  className="opacity-70"
  style={{ filter: 'brightness(0)' }}
  sizes="16px"
/>
```

**4. `app/blog/[slug]/page.tsx` — MDX content images (line ~117-125):**
The custom `img` MDX component renders inside `max-w-screen-md` (672px). On mobile, images are full viewport width. On desktop, they max out at 672px.

Add `sizes` prop to the `img` component in `mdxComponents`:
```tsx
img: (props: React.ImgHTMLAttributes<HTMLImageElement>) => (
  <Image
    className="rounded-lg my-4 max-w-full"
    src={(props.src as string) ?? ''}
    alt={props.alt ?? ''}
    width={typeof props.width === 'number' ? props.width : 800}
    height={typeof props.height === 'number' ? props.height : 400}
    sizes="(max-width: 768px) 100vw, 672px"
  />
),
```
  </action>
  <verify>
- `grep -rn "sizes=" app/projects/page.tsx app/components/tech-stack.tsx app/about-me/page.tsx "app/blog/[slug]/page.tsx"` shows a `sizes` prop on every `<Image>` usage
- `grep -rn "priority" app/` confirms `priority` is ONLY on above-fold images (navbar PFP). No below-fold images should have `priority`. If any non-navbar image has `priority`, remove it. (OPT-03 requirement: "priority on above-fold images only")
- `npm run build` succeeds
- No Next.js warnings about missing sizes props in build output
  </verify>
  <done>Every next/image usage has a correct sizes prop: featured projects get "(max-width: 768px) 100vw, 50vw", tech-stack icons get "(max-width: 768px) 24px, 40px", about-me icons get "16px", and MDX images get "(max-width: 768px) 100vw, 672px". Only the navbar above-fold image has priority; no below-fold images have priority</done>
</task>

<task type="auto">
  <name>Task 2: Extract GitHub repos into async Server Component with Suspense boundary</name>
  <files>
    app/projects/_components/github-repos.tsx
    app/projects/_components/github-repos-skeleton.tsx
    app/projects/_components/github-repos-error.tsx
    app/projects/page.tsx
  </files>
  <action>
Restructure the projects page so the page shell (header + featured projects) renders immediately while GitHub data streams in via a Suspense boundary. Per user decision: skeleton cards as fallback, no spinner, error state with retry button when GitHub data fails to load.

**1. Create `app/projects/_components/github-repos-error.tsx` — Client error component with retry:**

This is a `'use client'` component that displays an in-section error message with a retry button when the GitHub fetch fails. It uses `useRouter().refresh()` to trigger a re-render of the Server Component (which will re-fetch).

```tsx
'use client';

import { useRouter } from 'next/navigation';

export default function GitHubReposError() {
  const router = useRouter();

  return (
    <section>
      <div className="flex items-center justify-between mb-5">
        <h2 className="text-lg font-semibold text-slate-900">Open Source</h2>
      </div>
      <div className="rounded-xl border border-slate-200 bg-white p-8 text-center">
        <p className="text-slate-600 mb-4">
          Unable to load GitHub repositories. Please try again.
        </p>
        <button
          onClick={() => router.refresh()}
          className="px-4 py-2 text-sm font-medium text-white bg-cat-sky rounded-lg hover:bg-cat-sky/90 transition-colors"
        >
          Retry
        </button>
      </div>
    </section>
  );
}
```

**2. Create `app/projects/_components/github-repos.tsx` — Async Server Component:**

Extract the `GitHubRepoCard` component and the GitHub repos section from `app/projects/page.tsx` into a new async Server Component. This component fetches GitHub data and renders the repo cards. Wrap the fetch in a try/catch so that errors are caught and the error component is rendered in-section (not a full-page error).

```tsx
import { fetchGitHubRepos, languageColors, type ProcessedRepo } from '@/app/lib/github';
import GitHubReposError from './github-repos-error';

function GitHubRepoCard({ repo }: { repo: ProcessedRepo }) {
  // Move the existing GitHubRepoCard component here exactly as-is from projects/page.tsx
  // (the full component with language color, stars, forks, topics rendering)
}

export default async function GitHubRepos() {
  let githubRepos: ProcessedRepo[];

  try {
    githubRepos = await fetchGitHubRepos();
  } catch {
    // Per user decision: show an in-section error message with retry button
    return <GitHubReposError />;
  }

  if (githubRepos.length === 0) {
    return null;
  }

  return (
    <section>
      <div className="flex items-center justify-between mb-5">
        <h2 className="text-lg font-semibold text-slate-900">Open Source</h2>
        <a
          href="https://github.com/Xndr2"
          target="_blank"
          rel="noopener noreferrer"
          className="text-sm text-slate-500 hover:text-cat-sky transition-colors flex items-center gap-1"
        >
          View all
          <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
          </svg>
        </a>
      </div>
      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
        {githubRepos.slice(0, 6).map(repo => (
          <GitHubRepoCard key={repo.id} repo={repo} />
        ))}
      </div>
    </section>
  );
}
```

**3. Create `app/projects/_components/github-repos-skeleton.tsx` — Skeleton fallback:**

Create a skeleton that matches the real GitHub repos section layout to minimize layout shift. Use the same grid structure and card shapes. Show 3 skeleton cards (matching the existing loading.tsx pattern). Do NOT mark this as "use client" — it's a pure presentation Server Component.

```tsx
export default function GitHubReposSkeleton() {
  return (
    <section>
      <div className="flex items-center justify-between mb-5">
        <div className="h-5 bg-slate-200 rounded w-28 animate-pulse" />
        <div className="h-4 bg-slate-100 rounded w-16 animate-pulse" />
      </div>
      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
        {[1, 2, 3].map(i => (
          <div
            key={i}
            className="p-5 rounded-xl border border-slate-200 bg-white animate-pulse"
          >
            <div className="h-4 bg-slate-200 rounded w-1/2 mb-3" />
            <div className="h-3 bg-slate-100 rounded w-full mb-2" />
            <div className="h-3 bg-slate-100 rounded w-3/4 mb-4" />
            <div className="flex gap-3">
              <div className="h-3 bg-slate-100 rounded w-16" />
              <div className="h-3 bg-slate-100 rounded w-10" />
            </div>
          </div>
        ))}
      </div>
    </section>
  );
}
```

**4. Update `app/projects/page.tsx` — Remove async, add Suspense:**

The page component should NO LONGER be async. Remove `fetchGitHubRepos()` from the page. Remove the `GitHubRepoCard` component (moved to github-repos.tsx). Remove the GitHub import. Add Suspense wrapping the new `GitHubRepos` component.

The page should:
- Import `{ Suspense }` from `'react'`
- Import `GitHubRepos` from `./_components/github-repos`
- Import `GitHubReposSkeleton` from `./_components/github-repos-skeleton`
- Remove the `async` keyword from the default export function
- Keep the static header + featured projects section exactly as-is
- Replace the `{githubRepos.length > 0 && (<section>...` block with:
  ```tsx
  <Suspense fallback={<GitHubReposSkeleton />}>
    <GitHubRepos />
  </Suspense>
  ```
- Remove unused imports: `fetchGitHubRepos`, `languageColors`, `ProcessedRepo`
- Keep all other imports (Image, Link, Navbar, featured project images)

**5. Add route-level ISR revalidation to projects page:**

Add this export to `app/projects/page.tsx`:
```tsx
export const revalidate = 300; // Revalidate every 5 minutes
```

This is within the user's requested range of 1-5 minutes. It overrides the per-fetch `revalidate: 86400` in github.ts (the lowest value wins for route caching). Also update `app/lib/github.ts` to align: change `revalidate: 86400` to `revalidate: 300` in the fetch options, so the Data Cache and Route Cache are consistent.
  </action>
  <verify>
- `app/projects/_components/github-repos.tsx` exists and exports a default async function
- `app/projects/_components/github-repos-skeleton.tsx` exists and exports a default function
- `app/projects/_components/github-repos-error.tsx` exists with `'use client'` directive and a retry button using `router.refresh()`
- `grep "try" app/projects/_components/github-repos.tsx` shows the try/catch wrapping fetchGitHubRepos
- `grep "GitHubReposError" app/projects/_components/github-repos.tsx` shows the error component import and usage in catch block
- `app/projects/page.tsx` is NOT async (no `async` keyword on the default export)
- `grep "Suspense" app/projects/page.tsx` shows the Suspense import and usage
- `grep "revalidate" app/projects/page.tsx` shows `export const revalidate = 300`
- `grep "revalidate" app/lib/github.ts` shows `revalidate: 300`
- `npm run build` succeeds
- `npm run type-check` passes with no TypeScript errors
  </verify>
  <done>GitHub repos section extracted into async Server Component with try/catch error handling, wrapped in Suspense with skeleton fallback, in-section error component with retry button for fetch failures, page shell renders immediately, ISR revalidation set to 5 minutes</done>
</task>

<task type="auto">
  <name>Task 3: Configure static asset cache headers in next.config.js</name>
  <files>next.config.js</files>
  <action>
Add Cache-Control headers for static public assets that don't change (icons, project images). Next.js automatically sets `Cache-Control: public, max-age=31536000, immutable` on hashed `_next/static/` assets, but public folder assets under `/icons/` and `/projects/` need explicit headers.

In `next.config.js`, update the `headers()` function to add cache rules for static public assets AFTER the existing security headers block:

```javascript
async headers() {
  return [
    {
      source: '/(.*)',
      headers: [
        // ... existing security headers (keep all of them) ...
      ],
    },
    // Cache headers for static public assets
    {
      source: '/icons/:path*',
      headers: [
        {
          key: 'Cache-Control',
          value: 'public, max-age=31536000, immutable',
        },
      ],
    },
    {
      source: '/projects/:path*',
      headers: [
        {
          key: 'Cache-Control',
          value: 'public, max-age=31536000, immutable',
        },
      ],
    },
  ];
},
```

These assets are fingerprinted by content (images don't change), so `immutable` with 1-year max-age is appropriate. On Vercel, this translates to CDN edge cache instructions.

NOTE: Do NOT add Cache-Control to the catch-all `/(.*)`route — that would override Next.js's built-in dynamic page caching (ISR s-maxage headers).
  </action>
  <verify>
- `grep -A2 "immutable" next.config.js` shows the new cache headers for `/icons/` and `/projects/`
- `npm run build` succeeds
- The existing security headers (X-Frame-Options, X-Content-Type-Options, etc.) are still present and unchanged
  </verify>
  <done>Static asset cache headers configured for /icons/ and /projects/ paths with immutable 1-year max-age, existing security headers preserved</done>
</task>

</tasks>

<verification>
- Every `<Image>` component in the codebase (except navbar, which was already correct) has a `sizes` prop
- `grep -rn "priority" app/` confirms only the navbar image has `priority` (no below-fold images)
- `app/projects/page.tsx` uses `<Suspense>` with `GitHubReposSkeleton` fallback wrapping the async `GitHubRepos` component
- `app/projects/_components/github-repos.tsx` has try/catch wrapping fetchGitHubRepos, rendering `GitHubReposError` on failure
- `app/projects/_components/github-repos-error.tsx` is a `'use client'` component with a retry button
- `app/projects/page.tsx` is NOT async — the page function renders synchronously
- `export const revalidate = 300` is set on the projects route
- `app/lib/github.ts` fetch uses `revalidate: 300` (aligned with route)
- `next.config.js` has immutable cache headers for `/icons/` and `/projects/` paths
- `npm run build` succeeds with no errors
- `npm run type-check` passes
</verification>

<success_criteria>
1. All `next/image` usages have correct `sizes` props matching their responsive behavior, and only above-fold images have `priority` (OPT-03 satisfied)
2. Projects page GitHub data is wrapped in `<Suspense>` with skeleton fallback — page shell renders immediately (OPT-08 satisfied)
3. When GitHub fetch fails, an in-section error message with retry button is displayed (per locked user decision)
4. ISR revalidation set to 300 seconds (5 minutes) on projects route, aligned between route and fetch levels (OPT-04 partially satisfied)
5. Static asset Cache-Control headers set to immutable with 1-year max-age for icons and project images (OPT-04 fully satisfied)
6. Build and type-check pass clean
</success_criteria>

<output>
After completion, create `.planning/phases/02-performance-optimization/02-02-SUMMARY.md`
</output>
